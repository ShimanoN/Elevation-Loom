# 獲得標高トレーニング鏡アプリ MVP仕様書 v2.1

---

## 1. 目的

本アプリは、トレイルランナーが**日々の獲得標高トレーニングを客観的に把握し、判断の質を高めるための「鏡」**として機能することを目的とする。

- コーチングや指示は行わない
- 判断はユーザーに委ねる
- 数値と状態を正確に映すことに徹する

最終的なゴールは「再現可能なトレーニングプロセス」を蓄積し、その結果として**強くなった身体**を得ることにある。

---

## 2. 基本コンセプト

- フォーカスは**今週（ミクロサイクル）**のみ
- マクロ・メゾ視点は後付け可能だが、MVPでは扱わない
- 標準化された枠組みの中で、例外＝判断を正しく記録する
- 毎日見ることを前提としたUI（洗面台の鏡）

---

## 3. 画面構成（MVP）

### 3.1 日次入力画面（メイン画面）

**表示内容**

- 対象日付（日付選択UI付き）
- 1部獲得標高入力欄
- 2部獲得標高入力欄
- 1日合計獲得標高（自動計算・表示のみ）
- 主観コンディション（1日1回）
  - 良い / 普通 / 悪い（3段階ラジオボタン）
- 今週の進捗表示エリア
  - 週の期間（例: 2026/02/03 - 02/09 月曜始まり）
  - 週目標獲得標高（未設定時は「目標未設定」表示）
  - 現在の週合計
  - 目標との差分（目標設定時のみ）

**仕様**

- 起動時は当日の日次入力画面を表示
- 入力は任意のタイミングで可能
- 保存は自動実行（後述の発火ロジック参照）
- 未入力日は自動的に0扱い
- 過去30日以内への遡り入力を許可（それ以前は閲覧不可）
- 数値入力フィールドからフォーカスアウト時、フィールド境界が微妙に変化（保存完了の視覚的フィードバック）

**用語定義**

- **1部/2部**: 時刻ではなく順序ベース
  - 1部 = その日最初のトレーニングセッション
  - 2部 = その日2回目のトレーニングセッション
  - 1日1回のみの場合は1部のみ使用
- **主観コンディション**: 1日の終わり（推奨: 就寝前）に記録する、その日全体の体調評価
  - ラジオボタンは何度でも変更可能（UIレベルの制限なし）
  - 変更の都度、DayLogレコードを上書き保存
  - 「1日1回」の意味: 1日につき1つの値のみ保持（履歴なし）

---

### 3.2 週目標設定画面

**表示内容**

- 今週の情報
  - Week番号（ISO Week形式: YYYY-Wnn）
  - 開始日〜終了日（月曜始まり）
  - 週の目標獲得標高入力欄
  - 現在の週合計（参考値として表示）

例：

```
Week 2026-W06
2026/02/03 - 2026/02/09
目標獲得標高: 3000m
現在の進捗: 1200m
```

**仕様**

- 今週のみ表示・編集可能
- 過去週・未来週の目標設定は不可（今週のみフォーカス）
- 過去週の目標閲覧機能はMVPでは実装しない（データは保持するが、UI上は今週のみアクセス可能）
- 未入力時は空欄表示（デフォルト値・推奨値の提示なし）
- 入力フィールドからフォーカスアウト時に自動保存

---

## 4. データモデル（MVP）

### 4.1 DayLog

| フィールド名 | 型 | 説明 |
|---|---|---|
| date | DATE | 対象日付（YYYY-MM-DD、プライマリキー） |
| elevation_part1 | INTEGER | 1部獲得標高（m、NULL許可） |
| elevation_part2 | INTEGER | 2部獲得標高（m、NULL許可） |
| elevation_total | INTEGER | 1日合計獲得標高（m、保存時自動計算） |
| subjective_condition | ENUM | 主観コンディション（good/normal/bad、NULL許可） |
| iso_year | INTEGER | 所属するISO週年（保存時自動計算） |
| week_number | INTEGER | 所属するISO週番号（保存時自動計算） |
| timezone | STRING | 記録時のタイムゾーン（例: Asia/Tokyo） |
| created_at | TIMESTAMP | 初回作成日時（UTC、自動設定） |
| updated_at | TIMESTAMP | 最終更新日時（UTC、自動設定） |
| version | INTEGER | 楽観的ロックバージョン（初期値1） |

**インデックス**
- PRIMARY KEY: date
- INDEX: (iso_year, week_number) - 週集計クエリの高速化

**計算ルール**

```
elevation_total = COALESCE(elevation_part1, 0) + COALESCE(elevation_part2, 0)
```

**計算タイミング詳細**
- 1部/2部いずれかの保存時に都度再計算
- 保存トランザクション内でUPDATE前に計算実行
- DBレベルの制約: elevation_total は常に part1 + part2 と一致

**ISO Week計算**
- 保存時に date から自動計算
- iso_year/week_number は DayLog INSERT/UPDATE 時に自動設定
- 計算ロジックはWeekTargetと同一（整合性保証）

**楽観的ロックの実装**
- 初期値: 1
- 更新時: `WHERE date = :date AND version = :current_version`
- 更新成功: `version = version + 1`
- 更新失敗（競合検出）:
  - MVPでは単一デバイス前提のため競合は発生しない想定
  - 競合検出時は後勝ち（最新データで上書き）
  - 将来のマルチデバイス対応時に競合解決UI追加予定

---

### 4.2 WeekTarget

| フィールド名 | 型 | 説明 |
|---|---|---|
| iso_year | INTEGER | ISO週年（例: 2026） |
| week_number | INTEGER | ISO週番号（1-53） |
| start_date | DATE | 週開始日（月曜日、自動計算） |
| end_date | DATE | 週終了日（日曜日、自動計算） |
| target_elevation | INTEGER | 目標獲得標高（m、NULL許可） |
| created_at | TIMESTAMP | 初回作成日時（UTC、自動設定） |
| updated_at | TIMESTAMP | 最終更新日時（UTC、自動設定） |

**複合プライマリキー**: (iso_year, week_number)

**週定義**

- ISO 8601準拠
- 週の始まり: 月曜日
- 年初の定義: 木曜日を含む週が年初週
- UI表示: "YYYY/MM/DD - MM/DD" 形式

**ISO Week計算の実装方針**
- バックエンドで iso_year/week_number から自動計算
- start_date/end_date は INSERT時に自動設定（ユーザー入力不可）
- 計算ライブラリ: 
  - iOS: `Calendar.component(.weekOfYear)` + ISO8601Calendar
  - Android: `Calendar.get(Calendar.WEEK_OF_YEAR)` with Locale
  - サーバー: ISO8601 標準関数
- 年跨ぎ例:
  - 2025-12-29(月) = 2026-W01（木曜が2026年のため）

---

## 5. 保存・発火ロジック

### 5.1 自動保存の発火ポイント

以下の操作時に該当データを自動保存：

1. **入力フィールドからフォーカスアウト**
   - 1部/2部の数値入力フィールド
   - 週目標入力フィールド
   
2. **主観コンディション選択**
   - ラジオボタンクリック直後

3. **画面遷移時**
   - 日付変更操作（前日/翌日ボタン、カレンダー選択）
   - 画面切替（日次⇔週目標）
   - 遷移前に未保存データがある場合、0.5秒間の確認トースト表示
     - 「データを保存しました」（自動消滅）

### 5.2 保存戦略

- **即座同期方式**（オンライン前提）
  - ローカルストレージへの即座書き込み
  - サーバーへの非同期送信（バックグラウンド）
  - 送信失敗時は再試行キューに追加

### 5.3 エラーハンドリング

**ネットワーク断時の挙動**
- ローカル保存成功: フィールド境界変化（通常通り）
- サーバー送信失敗時:
  - 画面上部に控えめなバナー表示
  - 「オフライン（データは端末に保存済み）」
  - 自動再送キューに追加
  - 復帰時に自動同期 → バナー消滅
  - 同期中の視覚表現: ステータスバーアイコン点滅

**競合検出時**
- version フィールドで楽観的ロック
- 競合時（MVPでは想定外だが念のため）: 後勝ちで上書き

---

## 6. 計算・表示ロジック（MVP）

### 6.1 基本計算

- **日合計** = 1部 + 2部（NULL は 0 として扱う）
- **週合計** = 当該Week内（月曜〜日曜）の日合計の総和

**週合計の実装方式**
- リアルタイム集計（事前計算なし）
- 表示時にDayLogテーブルをクエリ:
  ```sql
  SELECT SUM(elevation_total) 
  FROM DayLog 
  WHERE iso_year = :year 
    AND week_number = :week
  ```
- キャッシュなし（MVPではデータ量少なくパフォーマンス問題なし）
- パフォーマンス要件: 100ms以内（セクション13.2参照）
- 将来: 週100件超えたら週次集計テーブル検討

### 6.2 表示可能な情報

日次入力画面の週進捗エリアに表示：

- 現在の週合計（m）
- 目標との差分（m）※目標設定時のみ
- 目標比（%）※目標設定時のみ

**表示例**

```
今週の進捗（2026/02/03 - 02/09）
目標: 3000m
現在: 1800m
差分: -1200m（60%）
```

### 6.3 解釈の排除

- 数値の色分け（赤/緑等）なし
- 「順調」「遅れ」等の評価文言なし
- グラフ・チャートなし
- あくまで数値の提示のみ

---

## 7. エッジケース定義

### 7.1 日付跨ぎトレーニング

- 23:00開始、翌1:00終了のトレーニング
- **ルール**: 開始時刻の日付に記録
- 例: 2/5 23:00開始 → 2/5の1部または2部に記録

### 7.2 遡り入力の制限

- **許可範囲**: 過去30日以内
- **制限範囲**: 31日以前は編集不可

**MVPでの扱い**
- 日次入力画面の日付選択: 過去30日のみ選択可能
- 31日以前のデータ: UI上アクセス不可（将来のレビュー機能で対応）
- データ保持: 365日分（将来拡張のため）

**30日制限の理由**
- 記憶の曖昧性を排除
- リアルタイム記録の習慣化
- 1ヶ月（≒メゾサイクル）が遡り可能な最大単位
- 遠征後のまとめ入力にも対応可能

### 7.3 データ修正

- 過去30日以内のデータは修正可能
- 修正時は updated_at を更新
- 修正履歴の保存はMVPでは不実施

### 7.4 週跨ぎの扱い

- Week定義: 月曜0:00 - 日曜23:59（ISO Week準拠）
- 日曜23:30のトレーニング → その週に含む
- 月曜0:30のトレーニング → 新しい週に含む

---

## 8. 初期状態・空状態の定義

### 8.1 初回起動時

**日次入力画面**

- 対象日付: 当日
- 全入力フィールド: 空欄
- 週進捗エリア: 「目標未設定」表示
- ガイドメッセージ: 「今週の目標を設定してください」（1回のみ表示、以降非表示）

**週目標設定画面**

- 今週の週番号・期間を表示
- 目標入力欄: 空欄
- 現在の進捗: 0m

### 8.2 データ未入力時

- 1日合計: 0m と表示
- 週合計: 0m と表示
- 目標との差分: 目標未設定時は非表示

### 8.3 週目標未設定時

**表示内容詳細**
```
今週の進捗（2026/02/03 - 02/09）
目標: 未設定
現在: 1200m

[週目標を設定] ← タップで週目標設定画面へ
```

- 「目標未設定」テキストまたは「週目標を設定」ボタンはタップ可能（週目標設定画面へ遷移）
- 初回のみツールチップ表示「週目標を設定すると差分が見えます」（2秒後に自動消滅）
- 差分・目標比は非表示
- 週合計のみ表示

---

## 9. 画面遷移定義

### 9.1 画面構成

```
[日次入力画面] ⇔ [週目標設定画面]
     ↓
  [過去日]
```

### 9.2 遷移パターン

| 起点 | 操作 | 遷移先 |
|---|---|---|
| 日次入力 | 週進捗エリアタップ | 週目標設定 |
| 日次入力 | 「週目標を設定」ボタンタップ | 週目標設定 |
| 週目標設定 | 戻るボタン | 日次入力（当日） |
| 日次入力 | 前日ボタン | 日次入力（前日） |
| 日次入力 | 翌日ボタン | 日次入力（翌日） |
| 日次入力 | カレンダーアイコン | 日付選択ダイアログ |

### 9.3 起動時の挙動

- アプリ起動 → 日次入力画面（当日）を表示

---

## 10. 最小限の成功指標

MVPの有効性を検証するための指標：

### 10.1 定量指標

- **7日継続率**: 初回起動から7日間、毎日データ入力を完了したユーザーの割合
  - 目標: 60%以上
  
- **30日継続率**: 初回起動から30日間、週4日以上データ入力を完了したユーザーの割合
  - 目標: 40%以上

- **週目標設定率**: 週目標を設定したユーザーの割合
  - 目標: 80%以上

- **主観コンディション入力率**: データ入力日のうち、主観コンディションも記録した日の割合
  - 目標: 50%以上（下回った場合、Phase 2で削除検討）

### 10.2 定性指標

- ユーザーインタビュー（n=5）での評価
  - 「鏡として機能している」と感じるか
  - 判断の質が向上したと感じるか
  - 継続使用の意思があるか

---

## 11. MVPで実装しないもの

以下の機能はMVP範囲外とし、将来的な拡張として保留：

- グラフ可視化（週/月の推移）
- 背景色による主観状態表現
- 距離 / 時間 / 心拍など他指標
- AIによる提案・警告・コーチング
- SNS連携
- Strava等の外部サービス連携
- データエクスポート機能
- マルチデバイス同期（MVPは単一デバイス前提）
- 過去週・未来週の目標設定
- 過去週の目標・実績閲覧機能（データは保持、UIなし）

---

## 12. 将来的な拡張余地（参考）

**Phase 2 候補**

- グラフ表示（主観状態を背景色で表現）
- 過去4週間の振り返り表示
- 月次レビュー機能
- データエクスポート（CSV/JSON）
- GDPR対応（データ削除リクエスト）

**Phase 3 候補**

- Strava自動連携
- 心拍・パワーデータ統合
- 四半期レビュー
- マルチデバイス同期

**Phase 4 候補**

- AIモデル向けデータエクスポート
- コーチング機能（判断支援）
- マクロサイクル計画機能

---

## 13. 技術的制約・前提条件

### 13.1 動作環境

- プラットフォーム: iOS / Android（ネイティブアプリ）
- 最小バージョン: iOS 15.0 / Android 10.0
- ネットワーク: オンライン前提（オフライン対応はPhase 2）

### 13.2 パフォーマンス要件

- 画面遷移: 300ms以内
- データ保存（ローカル）: 500ms以内
- 週合計計算: 100ms以内
- サーバー同期: バックグラウンド実行（ユーザー体感に影響なし）

### 13.3 データ保持

- **ローカル**: 過去365日分
- **サーバー**: 
  - 通常: 無期限保持
  - ユーザー削除: アカウント削除から30日後に全データ削除
  - GDPR対応: データエクスポート機能（Phase 2で実装）
  - 論理削除: deleted_at カラム追加（物理削除は避ける、Phase 2で実装）

---

## 14. 実装優先度

### P0（MVP必須）

- 日次入力画面の基本機能
- 週目標設定画面
- DayLog / WeekTarget の CRUD
- 自動保存ロジック
- 週合計計算
- ISO Week計算ロジック

### P1（MVP推奨）

- オフライン時のエラーハンドリング
- 楽観的ロック実装
- 主観コンディション機能
- 初回起動時ガイド

### P2（あれば良い）

- アニメーション・トランジション
- ツールチップ
- 詳細なエラーメッセージ

---

## 改訂履歴

- v1.0: 初版ドラフト
- v2.0: レビュー反映版
  - Week目標を今週のみに限定（コンセプト整合）
  - 自動保存ロジックを安全化（確認フロー追加）
  - Week定義を明確化（ISO Week、月曜始まり）
  - エッジケース・初期状態・画面遷移を追加
  - 成功指標を追加
  - 午前/午後 → 1部/2部に用語変更
- v2.1: 実装レビュー反映版（最終監査版）
  - 過去週閲覧UIの削除を明記
  - elevation_total計算タイミングを明確化
  - 週合計計算の実装方式を明記（リアルタイム集計）
  - DayLogにiso_year/week_number追加（週集計最適化）
  - saved_at → created_at リネーム（命名規則統一）
  - 主観コンディションの動作仕様を詳細化
  - 週目標未設定時の表示内容を詳細化
  - エラーハンドリング（オフライン時）を詳細化
  - 楽観的ロックの実装詳細を追記
  - ISO Week計算の実装方針を追記
  - 実装優先度セクション追加

---

以上をMVP仕様 v2.1（実装可能版）とする。
